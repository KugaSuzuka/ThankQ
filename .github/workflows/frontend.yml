name: Deploy frontend to S3

on:
  push:
    branches: [ main ]
#    paths: [ "frontend/**" ]        # フロントに変更があるときだけ

env:
  AWS_REGION: ap-northeast-1
  DIST_DIR: frontend/dist           # Next.js: frontend/out
  S3_BUCKET: thankq-frontend-site

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 0) Checkout
      - uses: actions/checkout@v4
      # 1.1) pnpm を有効化（Corepack）
      - name: Enable pnpm
        run: corepack enable pnpm

      # 1) Node セットアップ（cache と lock ファイルのパスを指定）
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      # 1.5) 依存インストール & ビルド
      - name: Build frontend
        working-directory: frontend            # ← ここ大事
        run: |
          corepack enable pnpm
          pnpm install --frozen-lockfile
          pnpm run build

      # 2) AWS (OIDC AssumeRole)
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.CI_FRONTEND_ROLE_ARN }}
          aws-region:     ${{ env.AWS_REGION }}

      # 3) CloudFront ID / バケットパスをまとめて環境変数へ
      - name: Resolve resource IDs
        run: |
          CF_ID=${{ secrets.CLOUDFRONT_ID }}          # 固定値ならこれだけ
          echo "CLOUDFRONT_ID=$CF_ID" >> $GITHUB_ENV
          echo "SYNC_PATH=s3://${S3_BUCKET}" >> $GITHUB_ENV

      # 4) S3 sync
      - name: Upload to S3
        run: |
          aws s3 sync $DIST_DIR/ "$SYNC_PATH" \
            --delete \
            --cache-control "public,max-age=31536000,immutable"

      # 5) CloudFront Invalidate (任意)
      - name: Invalidate CloudFront
        if: env.CLOUDFRONT_ID != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "$CLOUDFRONT_ID" \
            --paths "/*"

      # 6) CDKTF deploy（必要なら）
      - uses: hashicorp/setup-terraform@v3
      - name: CDKTF deploy
        env: { CDKTF_DISABLE_PROMPTS: "true" }
        run: |
          cd cdktf
          pnpm ci
          pnpm cdktf deploy -auto-approve
